<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>贵州数字化预防接种系统</title>
	<meta name="renderer" content="webkit">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,c
	<meta http-equiv="Access-Control-Allow-Origin" content="*">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<meta name="apple-mobile-web-app-status-bar-style" content="black">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="format-detection" content="telephone=no">

	<link rel="shortcut icon" href="statics/images/favicon.ico">

	<link rel="stylesheet" href="statics/css/font-awesome.min.css">

	<link rel="stylesheet" href="statics/plugins/layui/css/layui.css" media="all">
	<link rel="stylesheet" href="statics/css/public/base.css" media="all">
	<link rel="stylesheet" href="statics/css/public/index.css" media="all">

	<link rel="stylesheet" href="statics/css/bootstrap.min.css">
	<link rel="stylesheet" href="statics/css/font-awesome.min.css">
	<link rel="stylesheet" href="statics/css/AdminLTE.min.css">
	<link rel="stylesheet" href="statics/css/all-skins.min.css">
	<link rel="stylesheet" href="statics/css/main.css">
	<!---->
	<!--<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>-->
	<!--<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>-->

	<style>
		.chk-input-towers{
			zoom: 250%;
			width: 30px;
			height: 20px;
			vertical-align:middle;
			margin-top: 10px;
			margin-right: 5px;
		}
		.chk-input-towers-text{
			vertical-align: middle;
			font-size: 25px;
			line-height: 20px;
			display: inline-block;
			height: 30px;
			position: relative;
			top: 13px;
			margin-left: -25px;
		}
	</style>
</head>
<script>
    var userName="$shiro.getBaseInfo('username')";
</script>
<body class="main_body">
<div class="layui-layout layui-layout-admin">
	<!-- 顶部 -->
	<div class="layui-header header">
		<div class="layui-main mag0">
			<a href="#" class="logo fl">
				<img src="statics/images/logo_new.png" alt="">
			</a>
			<!-- 顶部右侧菜单 -->
			<ul class="layui-nav top_menu fr">
				<li class="layui-nav-item" id="userInfo">
					<a href="javascript:;">
						<label class="adminName" id="adminName"></label>
					</a>
					<dl class="layui-nav-child">
						<!--<dd>
                            <a href="javascript:;" data-url="page/user/userInfo.html">
                                <i class="layui-icon layui-icon-user"></i>
                                <cite>个人资料</cite>
                            </a>
                        </dd>-->
						<dd>
							<a href="javascript:void(0);" id="changepwd" class="changepwd" onclick="updatePassword()">
								<i class="layui-icon layui-icon-password"></i>
								<cite>修改密码</cite>
							</a>
						</dd>
						<!--<dd pc>
                            <a href="javascript:;" class="functionSetting">
                                <i class="layui-icon layui-icon-set"></i>
                                <cite>功能设定</cite>
                            </a>
                        </dd>-->
						<dd>
							<a href="logout" class="signOut" class="signOut">
								<i class="layui-icon layui-icon-close"></i>
								<cite>退出</cite>
							</a>
						</dd>
					</dl>
				</li>
			</ul>
		</div>
	</div>
	<!-- 左侧导航 -->
	<div class="layui-side layui-bg-black">
		<div class="side-tips">
			系统导航
		</div>
		<div class="navBar layui-side-scroll" id="navBar">
			<ul class="layui-nav layui-nav-tree">
				<!-- <li class="layui-nav-item layui-this">
                    <a href="javascript:;" data-url="page/main.html"><i class="layui-icon" data-icon=""></i><cite>系统导航</cite></a>
                </li> -->
			</ul>
		</div>
	</div>
	<!-- 右侧内容 -->
	<div class="layui-body layui-form">
		<div class="layui-tab mag0" lay-filter="bodyTab" id="top_tabs_box">
			<a href="javascript:;" class="seraph hideMenu layui-icon layui-icon-shrink-right"></a>
			<ul class="layui-tab-title top_tab" id="top_tabs">
				<li class="layui-this" lay-id=""><i class="layui-icon">&#xe68e;</i> <cite>我的桌面</cite></li>
			</ul>
			<ul class="layui-nav closeBox">
				<li class="layui-nav-item">
					<a href="javascript:;"><i class="layui-icon caozuo">&#xe643;</i> 页面操作</a>
					<dl class="layui-nav-child">
						<dd><a href="javascript:;" class="refresh refreshThis"><i class="layui-icon layui-icon-refresh"></i> 刷新当前</a></dd>
						<dd><a href="javascript:;" class="closePageOther"><i class="layui-icon layui-icon-close-fill"></i> 关闭其他</a></dd>
						<dd><a href="javascript:;" class="closePageAll"><i class="layui-icon layui-icon-fonts-clear"></i> 关闭全部</a></dd>
					</dl>
				</li>
			</ul>
			<div class="layui-tab-content clildFrame">
				<div class="layui-tab-item layui-show">
					<iframe src="main.html" id="main"></iframe>
				</div>
			</div>
		</div>
	</div>
	<!-- 底部 -->
	<div class="layui-footer footer">
		<p>
			<span>Copyright <a href="http://www.gzjytc.com/">贵州精英天成科技股份有限公司</a>提供技术支持 &nbsp;&nbsp;服务电话：4001870851</span>
		</p>
	</div>
</div>
<div id="tmpl-content" class="pl30 pr30 pt30 pb30">
	<label class="tower-fc" style="align-content: center">请选择工作台</label>
	<hr>
	<div id="selectSM" class="tower-al"></div>
</div>


<!-- 修改密码 -->
<div id="passwordLayer" style="display: none;">
	<form class="form-horizontal">
		<div class="form-group">
			<div class="form-group">
				<div class="col-sm-2 control-label">账号</div>
				<span class="label label-success" style="vertical-align: bottom;" id="updateusername">{{user.username}}</span>
			</div>
			<div class="form-group">
				<div class="col-sm-2 control-label">原密码</div>
				<div class="col-sm-10">
					<input type="password" class="form-control" v-model="password" placeholder="原密码" id="password"/>
				</div>
			</div>
			<div class="form-group">
				<div class="col-sm-2 control-label">新密码</div>
				<div class="col-sm-10">
					<input type="text" class="form-control" v-model="newPassword" placeholder="新密码" id="newPassword"/>
				</div>
			</div>
		</div>
	</form>
</div>
<input type="text" id="usernamess" >

<!-- 移动导航 -->
<div class="site-tree-mobile"><i class="layui-icon">&#xe602;</i></div>
<div class="site-mobile-shade"></div>
<script type="text/javascript" src="statics/libs/jquery.min.js"></script>
<script type="text/javascript" src="statics/plugins/layui/layui.js"></script>
<script type="text/javascript" src="statics/js/public/index.js"></script>
<script type="text/javascript" src="statics/js/public/cache.js"></script>
</body>
</html>

<script>
    $(function () {
        $.ajax({
            url: "getLoginUserInfo",
            dataType: 'json',
            contentType:'application/json;charset=UTF-8',
            success : function(data){
				var towers=new Array();
				if (data.user.inoculateTowerId!=null){
				    towers.push({"id":data.user.inoculateTowerId});
				}
                if (data.user.registerTowerId!=null){
                    towers.push({"id":data.user.registerTowerId});
                }
                if (data.user.childProtectionTowerId!=null){
                    towers.push({"id":data.user.childProtectionTowerId});
                }
                if (data.user.preCheckId!=null){
                    towers.push({"id":data.user.preCheckId});
                }
                connect(towers);
                $("#adminName").html(data.user.realName);
                $("#updateusername").html(data.user.username);
                $("#usernamess").val(data.user.username);
            },error:function(){
                alert("获取数据失败,请联系管理员!");
            }
        });

    })
    var ws = null;

    function reconnect(connected) {
        $.ajax({
            url: "getLoginUserInfo",
            dataType: 'json',
            contentType:'application/json;charset=UTF-8',
            success : function(data){
                var towers=new Array();
                if (data.user.inoculateTowerId!=null){
                    towers.push({"id":data.user.inoculateTowerId});
                }
                if (data.user.registerTowerId!=null){
                    towers.push({"id":data.user.registerTowerId});
                }
                if (data.user.childProtectionTowerId!=null){
                    towers.push({"id":data.user.childProtectionTowerId});
                }
                if (data.user.preCheckId!=null){
                    towers.push({"id":data.user.preCheckId});
                }
                connect(towers);
            },error:function(){
                console.log("登录超时！,请重新登录!");
            }
        });
    }

    function connect(towerList) {

        var param=new Array();
        for(var i=0;i<towerList.length;i++){
            console.log(towerList[i].id);
            param.push(towerList[i].id);
        }
        var url=getPath()+"/onlineWebsockeHandler?towerList="+param.toString();
        url=updateUrl(url);
        if (url.indexOf("sockjs") != -1) {
            ws = new SockJS(url);
        } else {
            if ('WebSocket' in window) {
                ws = new WebSocket(url);
            } else {
                ws = new SockJS(url);
            }
        }
        ws.onopen = function () {
			console.log("链接成功了！")
            heartCheck.start();
        };
        ws.onmessage = function (event) {
            heartCheck.reset();


        };
        ws.onclose = function (event) {
            console.log("我掉线的重新链接！")
			reconnect();
        };
        ws.onerror = function () {
            reconnect();
        };

    }

    var heartCheck = {
        timeout: 6000,//60s
        timeoutObj: null,
        reset: function(){
            clearTimeout(this.timeoutObj);
            this.start();
        },
        start: function(){
            this.timeoutObj = setTimeout(function(){
                ws.send("HeartBeat");
            }, this.timeout)
        }
    }

    function updatePassword(){
        layer.open({
            type: 1,
            skin: 'layui-layer-molv',
            title: "修改密码",
            area: ['550px', '270px'],
            shadeClose: false,
            content: jQuery("#passwordLayer"),
            btn: ['修改','取消'],
            btn1: function (index) {
                var str=$("#usernamess").val();
                console.log(str);
                var data = "password="+$("#password").val()+"&newPassword="+$("#newPassword").val()+"&username="+str;
                $.ajax({
                    type: "POST",
                    url: "sys/user/password",
                    data: data,
                    dataType: "json",
                    success: function(result){
                        //请求地址换成平台的ip或者是域名
                        if(result.code == 0){
                                $.ajax({
                                    async: true,
                                    type: "GET",
                                    // url: "http://192.168.3.18:8080/yfjzplatform/sys/user/passwords?"+data,
                                    url: "http://47.99.168.173/yfjzplatform/sys/user/passwords?"+data,
                                    dataType: "jsonp",
                                    contentType: "application/jsonp;charset=utf-8",
                                    jsonp: 'jsoncallback',
                                    success: function(result){
                                        console.log(result);
                                        if(result.code == 0){
                                            layer.close(index);
                                            layer.alert('修改成功', function(index){
                                                    location.reload();
                                                });
                                                }else{
                                            layer.alert(result.msg);
                                        }
                                    }
                                });

                        }else{
                            layer.alert(result.msg);
                        }
                    }
                });
            }
        });
    }


    function disconnect() {
        if (ws != null) {
            ws.close();
            ws = null;
        }

    }

    function getPath() {
        var curPath = window.document.location.href;
        var pathName = window.document.location.pathname;
        var pos = curPath.indexOf(pathName);
        var localhostPath = curPath.substring(0, pos);
        var projectName = pathName.substring(0, pathName.substr(1).indexOf('/') + 1);
        return localhostPath + projectName;
    }
    function updateUrl(urlPath) {
        var url;
        if (window.location.protocol == 'http:') {
            url = url_replace(urlPath, "http", "ws");
        } else {
            url = url_replace(urlPath, "http", "wss");
        }

        return url
    }
    function url_replace(str, source, dest) {
        //第一个参数是要替换掉的内容，第二个参数"g"表示替换全部（global）。
        var regexp = new RegExp(source, "g"); //定义正则表达式
        // 第一个参数是正则表达式。 本例会将全部匹配项替换为第二个参数。
        return str.replace(regexp, dest);
    }

</script>